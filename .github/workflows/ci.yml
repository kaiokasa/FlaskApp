name: CI Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:

  #  JOB 1 : running the python test
  tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests
      run: pytest -v

  #  JOB 2 : Build Docker image
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Build Docker image
      run: docker build -t flaskapp:latest .


  #  JOB 3 : Push Docker images to registries

  push-images:
    needs: [tests, build]   # only run if tests + build succeed
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Log in to Docker Hub
      run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

    - name: Tag image for Docker Hub
      run: docker tag flaskapp:latest ${{ secrets.DOCKER_USERNAME }}/flaskapp:latest

    - name: Push to Docker Hub
      run: docker push ${{ secrets.DOCKER_USERNAME }}/flaskapp:latest

    - name: Log in to private registry
      run: echo "${{ secrets.PRIVATE_REGISTRY_PASSWORD }}" | docker login ${{ secrets.PRIVATE_REGISTRY_URL }} -u "${{ secrets.PRIVATE_REGISTRY_USERNAME }}" --password-stdin

    - name: Tag image for private registry
      run: docker tag flaskapp:latest ${{ secrets.PRIVATE_REGISTRY_URL }}/flaskapp:latest

    - name: Push to private registry
      run: docker push ${{ secrets.PRIVATE_REGISTRY_URL }}/flaskapp:latest

  #  JOB 4 : Notification if tests fail
  notify-on-failure:
    runs-on: ubuntu-latest
    needs: tests
    if: failure()

    steps:
    - name: Send email
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "‚ùå CI Pipeline Failed"
        to: "bouchentoufomar05@gmail.com"
        from: "GitHub Actions <bouchentoufomar05@gmail.com>"
        body: "A test has failed in the CI pipeline. Please check the Actions tab."

